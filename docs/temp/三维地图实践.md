# Arcgis 从二维到三维地图

头脑风暴

- 运维权限，三维地图服务如何配置，目前只支持二维地图服务
  - 前端配置文件
- 如何更好地嵌入三维地图
- 三维数据包括场景数据和高程数据，arcgis for api 如何加载处理
  - arcgis 4.9 api 所支持的三维服务如何
  - mapView（二维）
  - sceneView（三维）
  - 加载高程数据
    - ElevationLayer
    - TileLayer
  - 加载场景数据
    - SceneLayer
  - 加载三维影像数据
    - ImageryLayerView
- 加载三维图层时，不需要设置 baseMap 地图，因为不是叠加。
- 三维与二维的区别
- 二三维联动/切换
- 三维需求

坐标偏差我们常用的坐标有三种，分别是国际坐标系、火星坐标系、百度坐标系地球坐标系——WGS84：
- GCS_WGS_1984,常见于 GPS 设备，Google 地图、arcGIS 地图等国际标准的坐标体系。
- 火星坐标系——GCJ-02：中国国内使用的被强制加密后的坐标体系，高德坐标采用这种坐标体系。
- 百度坐标系——BD-09：百度地图所使用的坐标体系，是在火星坐标系的基础上又进行了一次加密处理。坐标偏差依赖于地图底图服务，上面将默认的英文地图转化成国内常用的天地图（默认火星坐标），这里就产生问题。1、不建议底图选择中存在两种不同坐标体系，如下图坐标存在明显的偏差，火星坐标在采用 WGS84 坐标系的地图上位置偏上彩色中国天地图

- 定位渲染
- 目前的基线 draw 无法使用
- 查询数据，在三维服务中一样可以正常查询

- 如何更好的接入，对于二三维一体化。是否需要新建一个 三维 map 组件专门处理。

  - 三维与二维其实更像是一个摄像机的正交
  - 运维权限
  - 二维与三维底图坐标系要一致。
  - 如果要在三维中，添加二维图层，通过共用 view，然后叠加
  - 是否要同步二维地图已经加载的图层，在三维地图中的显示，例如某个专题、查询的渲染效果，同步添加三维地图上。

- 图层的叠加要求
  - 参考坐标系一致 spatialReference
  - center/zoom/scale
  - 场景图层
  - camera 的设置
- [x] 二维叠加到三维地图上
- [ ] 天地图加载到三维
- [ ] 运维权限的配置底图
- 操作
  - 定位（二维要素的定位、三维要素的）
    - 经度与维度
    - x 与 y
  - 查询分析
- 实现：地图初始化、空间参考坐标系的问题了
  - 目标没有一个二维图层、三维高程同一个坐标系上的数据服务
- 下午在基础信息平台引入三维测试，二维地图的显示
- 地图是天地图，如果不正确设置的话，地图也会出不来

使用同一个 map 对象，实现特殊同步，如果需要集成再考虑后续处理。

```js
var view = new SceneView({
        container: "viewDiv",
        viewingMode: "global",
        map: map,
        camera: {
          position: {
            x: -168869,
            y: 3806095,
            z: 1618269,
            spatialReference: {
              wkid: 102100
            }
          },
          heading: 17,
          tilt: 48
        },
        constraints: {
          `snapToZoom: false`
        }
      });
```

## ArcGIS 三维数据生产

## ArcGIS 服务发布

10.7

ArcGIS Pro

## ArcGIS 三维服务使用

## 已知的限制

- 二维数据可以在三维地图中加载显示
- 三维数据不能在二维地图中加载显示
- 绘制工具暂无法支持三维数据

## 二三维一体化

### 地图是如何制作出来的——二维地图与三维地图

- 如何映射到二维地图
- 二维地图数据（x，y/经度、维度）如何映射叠加到三维球体
  - 能否直接添加等等
  - 切片与动态图层（切片加载，ArcGIS API 会对应请求到相对应的图片）
  - 坐标系统（本身集成到三维）

默认的二维也可以添加到三维地图上的，用了相同的世界坐标。

理解这些有利于确定二三维如何一体化，首先是展示上的一体化。

- 二三维切换（联动），同步数据、事件、查询结果
- 二维在三维地球中进行叠加

### 限制

Limitations about switching between 2D and 3D
Keep in mind that switching from a MapView to a SceneView requires careful consideration for a number of factors. See the list below for some of the factors of consideration. This list is not comprehensive.

- **Data types** - Some layers aren't supported in 2D because of their 3D nature. These include SceneLayer, IntegratedMeshLayer, and PointCloudLayer. They will need to be removed from the map instance altogether, or replaced with 2D counterparts. For example, you could switch a SceneLayer representing buildings with a polygon FeatureLayer representing building footprints. ElevationLayer doesn't need to be considered as closely as the other layers mentioned above since the Map's ground is ignored in MapViews.
- **Symbols** - While most 2D symbols are useable in SceneView, all 3D symbols are not supported in MapViews. Renderers may need to be reconfigured if 3D symbols are used.
- **UI components** - If adding widgets and other UI components using view.ui.add(), then keep in mind that these components need extra logic for persisting from one view to the next.
- **Widgets** - All widgets in the API are tied to a specific view. If persisting widgets from a 2D to 3D view is desired then extra logic will need to be included for switching the view referenced by each widget. This includes a view's popup instance.

### 是否二维和三维共用一个地图组件，考虑到复用公共的组件，在三维中能否使用二维地图的工具函数、初始化 ，或者说区分为不同的工具类合集。

最终想要实现的效果：

- 将二维和三维地图集成到同一个 GIS 中,在浏览器中并列显示二维和三维地图，实现二维和三维地图的联动和数据同步，用户就可以通过两个维度同时去观察和处理地理信息数据。
- 实现二维和三维地图的联动，数据显示、更新与分析结果的同步，并且与 OGC Web 服务无缝集成,完成了 WebGIS 二三维一体化的目标。

考虑指标：

- `底图加载`是否一致（需要做哪些处理），例如加载天地图、影像图等（）
  - 地图的 spatialReference 引用
  - 全球场景，对底图的切片本身有要求。
- `图层加载`（例如加载三维图层、在三维地图中加载二维图层，方法一致，除了高程图层）
- 要素（数据）查询（查询 API 几乎一致，除了 sceneLayer 的服务端和客户端查询，绘制工具需要添加三维符号，这个也不能直接复用，考虑到后续。可以逐步添加上。）
  - 属性查询、空间查询
  - 绘制工具是否一致，看了官网示例可以公开课（ArcGIS JavaScript API 开发 Web 3D 应用），不一致，绘制的是三维符号，但只不过是在原来的二维面增加了高度。本质上绘制应该也是可以查询到数据，测试后可以使用。只不过没有绘制出一个高度的效果。可以在二维图层绘制，但是如果是绘制的线是立体的，例如从某一个点从另外的三维的，也是 x，y，z 都改变的话，就不能简单复用了。
  - 二维的图层叠加后，一样可以点击对应图层的符号弹出弹框，只不过它是二维的。
- `要素定位`（不一致，除了 extent，还需要设置摄像机的处理。或者在三维中完全可以用摄像机替换掉 extent 的定位，添加 heading 和 tilt，不过 API 都是使用 goTo，只不过封装上需要处理）
  - 二维服务无法在三维地图中定位，如果默认不调整摄像机的情况下，是可以按照原来的二维那样进行定位的，因为默认是正交投影的视图。
  - 因此如果要正常在三维地图中定位二维的要素时，除了 x，y 坐标外，还要设置摄像机进行处理。（这个也跟 WebGL 的原理一致，Unity 3D 的游戏摄像机一致，这个例子可以看规划分析的开发适应性。）
- `要素符号化渲染`（渲染方法不一致，多了 3D SymbolLayer）
  - 可以对二维数据进行三维符号化（ 但是方式不太一样，多了符号的图层，例如对于 symbolLayer 的渲染）
    - 二维要素点能否直接显示为三维要素点，可以通过 symbolLayer 结合某个渲染字段作为 z 轴的信息。
    - 或者把二维数据添加 z 轴。
  - 三维的渲染
- `事件通信`（是否有二三维联动的需求）、数据同步（重点考虑），数据主要是同一个 Map 数据。
  - 二三维代码一体化，直接在初始化的时候就进行了同步，在初始化的时候，同时实例化了三维与二维的 mapView 与 SceneView。
  - 分开渲染，那么 sceneView 的数据不能够同步渲染。
  - 抽离一个共同的图层数据管理，在切换时进行同步。目前佛山的实践是没有同步数据的，而是重新进行了渲染，initMap 加载数据，在切换地图的时候就进行了渲染。这样的话，需要重新触发加载图层，例如在某个专题图层打开的情况，如何切换同步到三维。
  - 所以不仅仅考虑初始化，还要考虑编辑。
  - map 对象是一致的，这就是数据。在切换的时候，加载不同的 map？
- 能否能够集成现有的`运维的配置`，需要开发对应的三维地图配置
  - 针对三维图层的配置
- 如何配置

mapView 与 sceneView 都是两个图层，最好的数据更新即可同步。现有的架构。（架构）

- 三维中：本地视图（一块区域）与全球视图（一个球体）
- 如何在 WebGIS 中组合二三维的架构。
- 可以通过 ·localSence· 也可以转换到本二维视图。（这样就不用两个 view 了？功能上可能不够）

考虑如何引入，至于范围上会有多少的区别？如果要同步图层和数据的话，那么在一开始的增删改查也要对 Map 进行的处理，切换的时候，基于现在的 Map 进行实例化不同的地图 View 视图。（二维和三维视图）

map 是共同的数据，mapView 和 sceneView 是视图，以及一些处理的方法。

要素图层也可以发布不带有 z 的，可以通过 SceneLayer 进行链接管理显示要素的属性。主要 demo 为 [](http://localhost:8080/arcgis_js_v49_sdk/arcgis_js_api/sdk/latest/sample-code/sandbox/index.html?sample=layers-scenelayer-query-popup)

另外一种是服务发布了关联要素图层的场景图层，可以直接点击查询

![](../.vuepress/public/images/2020-07-16-18-35-27-scene-layer.png)

![](../.vuepress/public/images/2020-07-16-18-49-10-scene-layer.png)

demo

- 完全 Map 组件
  - styleProject
- 二三维一体化 demo
  - 设置 viewClass

LOD 是什么

- View 视图层
- Map 数据层

![](../.vuepress/public/images/2020-07-16-18-44-46-map.png)

ground：dm 图层

webScene 作为一个非 Global 的自定义三维地图，直接加载一个特定的三维地图。

### 绘制工具（geometry）

### 定位

### 查询

### 渲染

## 实现三维

arcgis for js api ：4.9

arcmap 软件版本：

三维数据：高程数据与场景数据

### 使用 View

### 二三维模式切换

## 架构处理

## 权限配置

## 参考资料

- [2019 年 Esri 技术公开课（9）使用 ArcGIS JavaScript API 开发 Web 3D 应用](https://malagis.com/esri-open-class-2019-07-16.html) 从 ArcGIS 三维数据产生、ArcGIS 服务发布、ArcGIS 三维服务使用。
- 这个可以引入到地图中[使用 Javascript API for ArcGIS 4.X 实现二三维一体化](https://blog.csdn.net/qq_36264495/article/details/78032997?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.nonecase&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.nonecase)
- [Esri Events](https://www.youtube.com/c/EsriEvents/search?query=3d) Esri 官方演讲视频
  - [Practical Guide to Building 3D Web Apps](https://www.youtube.com/watch?v=jmwCtQvGJTo)
- [ESRI 公开课 2019](https://malagis.com/category/esri-open-class-2019/2/)
- [WebGL 系列教程]()
- [node ~ zip 压缩 && 文件加密](https://juejin.im/post/5b455c41f265da0f9a2ccfe2)
- [百度地图]
- [SceneView](http://localhost:8080/arcgis_js_v49_sdk/arcgis_js_api/sdk/latest/api-reference/esri-views-SceneView.html)
- [arcgis api 4.x for js 之基础地图篇](https://zhuanlan.zhihu.com/p/33074260)
- [4.11API 在三维加载 wkid4490 天地图](http://zhihu.geoscene.cn/article/3942)
- [Switch view from 2D to 3D](http://localhost:8080/arcgis_js_v49_sdk/arcgis_js_api/sdk/latest/sample-code/views-switch-2d-3d/index.html)
