# 系统登录方案之 SSO 单点登录

头脑风暴

- 登录方式
- 授权方式
- 用户账号系统如何同步（我方与第三方）（授权模式）、运维同步读取（读取现有的用户表和权限、进行运维的再次构造同步）
- 理论 + 实战
- 单点登录与单点注销
- 全局会话与局部会话
- cas
- 登录方式
  - Cookie + Session 登录
  - Token 登录（JWT）
  - SSO 单点登录（优先）
  - OAuth 第三方登录
- 前后端分离
- 加密
- 应用
  - 分析百度与淘宝 SSO
  - github 授权登录
- 加密算法
  - 非对称（常用用于系统登录时，先通过接口获去公钥（后台可能通过域名判断是否发送公钥），然后把密码和公钥一起加密发送给后台，后台再使用私钥来解密。）
- 如何同步 sso 认证中心的用户表，例如给运维系统使用，可以得到授权连接它的数据，获取读写用户权限关联表的授权，然后跟现有的权限表进行关联。

## OAuth 2.0

- 授权码（authorization-code）
- 隐藏式（implicit）
- 密码式（password）
- 客户端凭证（client credentials）

注意，不管哪一种授权方式，第三方应用申请令牌之前，都必须先到系统`备案`，说明自己的身份，然后会拿到两个`身份识别码`：`客户端 ID（client ID）`和`客户端密钥（client secret）`。这是为了防止令牌被滥用，没有备案过的第三方应用，是不会拿到令牌的。

## 登录

目前的单点登录，相当于是一张图系统想要获取政务云的用户身份数据，从而进行同步登录。

这里所谓的单点登录是不是通过 iframe 嵌入进去的意思，如果是的话，就直接获取根域下的 cookie 就行了，至于用户账号权限体系这些直接（数据库的表同步）。

如果不是通过 iframe 嵌入的，可以直接共享同一个根域下的 Cookie 共享就可以了单点登录了。这里需要考虑是否还需要有一张图的退出了，因为登录都放到同一个认证中心。

方案一：

1. A 网站在请求 A 网站后端服务时，后端进行验证 cookie。（token） 是否有效，无效的话则跳转到统一认证中心进行用户的授权（比如输入账号和密码登录）。
2. 用户同意，统一认证中心就会重定向回 A 网站，同时发回一个 token。
3. A 网站后端获得 token 后，给 A 网站设置 cookie，并在统一认证中心设置该用户有效。
4. 然后 B 网站进入系统时，如何同步登录？

### 单点登录

#### 假的单点登录

- 同域共享 cookie（目前国土系统）

单点登录与单点注销。

1. 引入一个中间态的 Server
2. 基于 CAS 的 SSO 系统

单点登录也是用了授权模式，拿到认证中心的令牌，进行对保护资源的访问。

相比于单系统登录，SSO 需要一个独立的`认证中心`，只有认证中心能接受用户的用户名密码等安全信息，其他系统不提供登录入口，只接受认证中心的间接授权。间接授权通过令牌实现，SSO 认证中心验证用户的用用户名和密码没问题，创建`授权令牌`，在接下来的跳转过程中，授权令牌作为参数发送给各个子系统，子系统拿到令牌，即得到了授权，可以借此创建局部会话，`局部会话`登录方式与单系统的登录方式相同。这个过程，也就是单点登录的原理。

#### 部署图

单点登录涉及 SSO 认证中心与众子系统，子系统与 SSO 认证中心需要通信以`交换令牌`、`检验令牌`及发起`注销请求`，因而子系统必须`集成 SSO 的客户端`，SSO 认证中心则是 `SSO 服务端`，整个单点登录过程实质是 `SSO 客户端与服务端通信`的过程。

#### 实现

##### 6、sso-server 接收并处理令牌请求

令牌与系统注册地址通常存储在 key-value 数据库（如 redis）中，redis 可以为 key 设置有效时间也就是令牌的有效期。redis 运行在内存中，速度非常快，正好 sso-server 不需要持久化任何数据。

令牌与注册系统地址可以用下图描述的结构存储在 redis 中，可能你会问，为什么要存储这些系统的地址？如果不存储，`注销的时候就麻烦了`，用户向 sso 认证中心提交注销请求，`sso 认证中心注销全局会话，但不知掉哪些系统用此全局会话建立了自己的局部会话，也不知道要向哪些子系统发送注销局部会话`：

![](../.vuepress/public/images/2020-07-08-14-02-27-sso.png)

### 第三方登录

单点登录与第三方登录还是有区别的。一个是授权，也就是说不能在 A 网站进行退出所有关联的网站。

cookie： uid

session 是服务端自己维护的会话数据结构，可以根据 cookie 获取当前用户的 session 会话状态

## 应用


## 参考资料

- 理论
  - [现在用的比较多的单点登录技术是什么？](https://www.zhihu.com/question/342103776/answer/798611224?utm_source=wechat_session&utm_medium=social&utm_oi=710800537397764096&utm_content=first)
  - [全面介绍 SSO（单点登录）](https://juejin.im/post/5de46d28e51d4532c21facb3#heading-2) —— 结合项目查看
  - [OAuth 2.0 的一个简单解释](http://www.ruanyifeng.com/blog/2019/04/oauth_design.html)
  - [前端登录，这一篇就够了](https://mp.weixin.qq.com/s/VSBC_KL5UaVWHEFooUEHAA)
- 实战
  - [simple-sso](https://github.com/ankur-anand/simple-sso) nodeJS 版
  - [simple-sso](https://github.com/sheefee/simple-sso/tree/0.1) Java 版
