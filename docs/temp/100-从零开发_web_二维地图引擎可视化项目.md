# 从零开发 web 二维地图引擎可视化项目

## 前言

目标：

- 理解地图引擎编写原理
- 提升架构能力和工程化能力，模仿 leaflet（**够轻量**）
- 可视化能力（比如切片与屏幕的展示计算）
- 移动端能力（适应 PC 端和移动端）

目标读者：希望了解二维地图的展示原理，不需要很复杂，不在生产环境使用。

文章分类：

- 实践总结型

### 什么是二维地图引擎？

可以让开发者快速制作 web 在线地图的工具。

### 为什么需要二维地图引擎？

提升效率。

### 现阶段的二维地图引擎的分类

<img src="../.vuepress/public/images/2021-04-14-16-07-30.png" style="zoom:50%;" />

详细可以看这篇文章 [二维地图前端js api对比分析](https://zhuanlan.zhihu.com/p/350866070)，从多个维度对各个 API 进行对比，比如开发者活跃度与易用行、开发文档、发展潜力，通过优势、劣势、适用方向，比如 leaflet 适用 移动端简单地图项目。

## 全局考虑

### 需求分析

轻量级的二维地图可视化引擎。自顶向下。

#### 我们需要什么样的地图能力

新建地图容器=>start:新建地图容器
建立图层实例=>operation:建立图层实例
添加到地图容器=>operation:添加到地图容器
屏幕展示=>end:屏幕展示

1. 需要可以根据屏幕大小、地图中心、缩放等级，新建地图容器
2. 需要支持新建切片图层，添加到地图容器中，进行显示
3. 需要可以对地图进行交互，比如拖拽、缩放、双击
4. 需要支持 PC 端和移动端

```js
var map = L.map('map').setView([51.505, -0.09], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);
```

时序图

new layer -》addTo -〉map

### 架构设计

#### 我们应该怎么设计

##### 1. 需要可以根据屏幕大小、地图中心、缩放等级，新建地图容器

Map 类，实例化为一个 DOM 容器中，监听屏幕大小，地图中心、缩放等级。

##### 2. 需要支持新建切片图层，添加到地图容器中，进行显示

Tile 类，负责保存请求地址，以及生成每个分片 DOM，添加到 Map 类的 DOM 容器中。

##### 3. 需要可以对地图进行交互，比如拖拽、缩放、双击、

监听 Map Container 的 DOM 事件，调用 Tile、Map 类进行地图的展示变化。

##### 4. 需要支持 PC 端和移动端

处理 DOM 的响应式适配，最简单的方案可以是等比缩放。以及分别监听 PC 端和手机端的浏览器 DOM 事件。

### 前置基础知识准备

#### 二维地图的一些概念

##### 切片、 WMTS 服务

##### 比例尺、缩放等级

#### CSS3 z-index、transform 

#### 移动端、PC 端交互事件

## 局部实现

### 开发环境搭建

#### 技术架构

- 采用 ES6 开发
-  rollup 打包输出

#### 源码目录设计

- build ——构建配置
- dist ——输出文件
- docs——文档
- tests——测试文件
- src ——源码
  - na-map.js ——入口文件
  - dom 关于地图的dom渲染和dom事件封装。
  - map 地图的核心，地图相关逻辑（地图交互）
  - layer 图层相关逻辑。
  - geo 地图投影和坐标适配逻辑
  - core 移动端和PC 端适配判断、事件订阅发布、工具类

#### 打包文件输出

### 地图类设计

## 小结

## 参考资料

