# 地图渲染与图形定位

<!-- # 从生成数据到加载地图显示的过程 -->

## 头脑风暴

- 状态保存（混乱，不知道什么时候被更新，没有统一的管理）
  - 配置文件 JSON
  - Vuex
  - LocalStorage
- 是否有地图服务 URL
- 是否初始化范围
  - 初始范围和中心点
  - 参考坐标
- 地图地位
  - 行政区划定位
  - 从服务到
- 是否需要配置代理（跨域访问、token）
- 比例尺、缩放等级、地图中心
- 对 extend 进行 expand、缓冲区？

地图配置
- appConfig.json
- mapinit.json
- region.json

初始化范围，设置了初始化范围才会显示地图

## 渲染

数据的来源

## 定位

地图数据除了图片外，要实时渲染的话，就是根据描述图形的坐标数据进行绘制了。

### 行政区划定位

行政区代码，query 查询空间服务，获得 geometry 图形点数据，然后绘制图形，并根据 geometry 的值，算得边界框 xMin，yMin，xMax、yMax，从而获得 Extent 进行定位。

## 应用

```js
// 登录的时候调用
/**
 * @description 设置用户的地图定位范围，并存储在localStorage中
 * @param {String} ownRegion 行政区划代码
 */
export const setUserMapExtent = async ownRegion => {
  let mapConfig = store.getters.mapLocateInfo;
  if (
    ownRegion &&
    ownRegion !== "" &&
    ownRegion !== "000000000000" &&
    JSON.stringify(mapConfig) != "{}"
  ) {
    const res = await HttpRequest.get(mapConfig.url + "?f=json");
    if (res.status === 200) {
      let layers = "";
      for (let i = 0; i < res.data.layers.length; i++) {
        let layer = res.data.layers[i];
        if (layer.parentLayerId === -1) {
          layers += layer.id + ",";
        }
      }
      if (layers.length > 0) {
        layers = layers.substring(0, layers.lastIndexOf(","));
        let requestUrl =
          mapConfig.url +
          "/find?searchText=" +
          ownRegion +
          "&searchFields=" +
          mapConfig.field +
          "&layers=" +
          layers +
          "&returnGeometry=true&f=json";
        const request = await HttpRequest.get(requestUrl);
        if (request.status === 200) {
          if (
            request.data.results &&
            request.data.results[0] &&
            request.data.results[0].geometry &&
            request.data.results[0].geometry.rings
          ) {
            let rings = request.data.results[0].geometry.rings;
            if (rings && rings.length > 0) {
              let xTotal = 0;
              let yTotal = 0;
              let pointCount = 0;
              let xmin, xmax, ymin, ymax;
              for (let i = 0; i < rings.length; i++) {
                let ring = rings[i];
                for (let j = 0; j < ring.length; j++) {
                  pointCount++;
                  xTotal += ring[j][0];
                  yTotal += ring[j][1];
                  if (i === 0 && j === 0) {
                    xmin = xmax = ring[j][0];
                    ymin = ymax = ring[j][1];
                  } else {
                    if (ring[j][0] < xmin) xmin = ring[j][0];
                    if (ring[j][0] > xmax) xmax = ring[j][0];
                    if (ring[j][1] < ymin) ymin = ring[j][1];
                    if (ring[j][1] > ymax) ymax = ring[j][1];
                  }
                }
              }
              let x = xTotal / pointCount;
              let y = yTotal / pointCount;
              // 根据用户的行政区划 重设 map的定位信息
              Object.assign(store.getters.extent, {
                x: x,
                y: y,
                zoom: null,
                scale: null,
                extent: {
                  xmin: xmin,
                  xmax: xmax,
                  ymin: ymin,
                  ymax: ymax
                }
              });
            }
          } else {
            console.log("获取图层信息失败");
          }
        } else {
          console.log("获取图层信息失败");
        }
      } else {
        console.log("获取图层信息失败");
      }
    } else {
      console.log("获取图层信息失败");
    }
  } else {
    if (ownRegion === "000000000000") {
      let tempExtent = store.getters.defaultMapConfig.extent;
      tempExtent.extent = null;
      Object.assign(store.getters.extent, tempExtent);
    }
  }
  let storeMapExtent = store.getters.extent;
  localStorage.save(USER_MAPEXTENT, storeMapExtent);
};

```

proxy.js
```js
/**
 * @description 设置子系统地图底图、切换的权限，并存在localStorage中
 * @param {String} name 子系统路由标识
 */
export const basemapProxy = async name => {
  let systemcode = getSystemCodeByRoute(name);
  if (systemcode === null) {
    console.log("module指定错误");
    return;
  }
  if (moduleWithProxy === null) moduleWithProxy = {};
  if (moduleWithBasemap === null) moduleWithBasemap = {};
  if (!moduleWithProxy[name] || !moduleWithBasemap[name]) {
    // 未点过该子系统，进行存储
    let proxyHas = {};
    let basemapHas = [];
    let basemapList = [];
    let resources = await getOtherResources(systemcode);
    debugger;
    if (resources && resources.dataMap && resources.dataMap.length > 0) {
      // 几何服务
      resources.dataMap.forEach(service => {
        if (service.serviceType === "geometry") {
          geometryUrl = service.url;
        }
      });
```

## 参考资料

- 《人教版七年级地理上下册》